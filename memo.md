# ros2_eyeexplorer メモ
## トラッキング
特徴点の対応付で三次元復元はできる。ただ、その特徴点は一回復元したらもう終わり。<br>
特徴点の3次元位置とカメラの位置が既知であるとき、その次の同じ特徴点については画像上どこに表示されるか計算することができる。もしその範囲にないときには、その3次元復元した特徴点は消去する。

## 特徴点探索
カメラ移動方向は既知。距離もある程度推測可能（もしトラッキングが可能であれば透視射影行列からほぼどこに来るか計算できる）なので、特徴点の対応付けを行う際に探索範囲を絞ることで高速化できるとは思うんだな。

## 3次元復元候補とその確定
・誤対応を除去する意味で、特徴点の存在範囲をカメラの位置と透視射影変換から導出しその範囲にない3次元復元点は削除するアルゴリズム（カメラの位置が既知だからできる所業）（すでに三次元復元された特徴点をトラッキングしていればできる話）<br>
・新たに追加された特徴点に関しては三次元復元をとりあえず行い、三次元復元点候補にする<br>
・三次元復元候補点→確定までのフローを追加する感じ<br>
・これをしてれば対象が動いたときに候補点から当然復元点は削除されるので、とてもロバスト<br>
・さらにこの確定を行うところで3次元復元点の修正も行えるとベスト

## 三次元復元点の存在確率ノード設計
### 三次元復元ノード
入力：二枚の内視鏡画像、カメラ位置姿勢<br>
出力：三次元復元点（位置座標、色、特徴量を持つ）<br>

### 三次元点存在確率ノード
入力：三次元復元点（位置座標、色、特徴量）、キーフレーム画像、各キーフレーム時のカメラ位置姿勢<br>
・三次元復元点には位置とそこに存在する確率が入っている。<br>
・候補点は単純に２枚の画像から特徴点を抽出、マッチングし、カメラの位置を用いて三次元復元を行う。このときの確率を0.5とする。<br>
・次のカメラの位置と画像の入力があり、三次元復元点から画像への透視射影変換を行う。このときその透視射影した点周りに同等の特徴量のものが存在しなければその候補点の存在確率を下げる。<br>

# プログラム構成
## Tracking スレッド
- 特徴点の抽出
- カメラの位置取得
- キーフレーム作成
## Mapping スレッド
- キーフレームの挿入と削除
- 三次元復元点作成
- 点の占有格子地図作成

# 4/25
・[track_no, frame_id, u, v, R, t]を含んだPublisherの制作
・特徴点のマッチングについて、一つ前のフレームでトラッキングしてた点がknnMatchingの候補にあれば、それを優先的に使う
・Reconstructionノードの作成

# 3次元点の再投影について
すでに三次元復元した点について、再投影を現在のフレームに投影してその付近に同等の特徴点があるか確かめる。なければ「三次元復元点がまちがえている」or「眼球が移動してしまっている」と言える。つまりその三次元復元点を削除する言い訳になる。これをすることで、三次元復元点候補をもっと増やしても大丈夫なので、よりロバストに動作することを期待できる。
## 仕様
三次元点についてクラスを作成する。一つの点に対して必要な情報とは下記の通り。
- 三次元復元点
- どのKFを使用したか
- 特徴点情報(descriptor? cv::Keypoint?)
  
また、下記のような関数も必要
- 3次元点を現在のフレームに再投影してそもそもフレームに映り込むかどうかを判定する。映り込むのであればどこに映るかをcv::Point2fとして出力する。
- ある画像上の座標と特徴点情報を渡し、そこに同等の特徴点が存在するか判定する。
- 各特徴点にたいしてIDを降ってあげる。そしてそのIDをkeyとした辞書を作成。
- 十分確からしい三次元復元点を格納しpublish用に用意する
