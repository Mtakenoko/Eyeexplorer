# ros2_eyeexplorer メモ
## トラッキング
特徴点の対応付で三次元復元はできる。ただ、その特徴点は一回復元したらもう終わり。<br>
特徴点の3次元位置とカメラの位置が既知であるとき、その次の同じ特徴点については画像上どこに表示されるか計算することができる。もしその範囲にないときには、その3次元復元した特徴点は消去する。

## 特徴点探索
カメラ移動方向は既知。距離もある程度推測可能（もしトラッキングが可能であれば透視射影行列からほぼどこに来るか計算できる）なので、特徴点の対応付けを行う際に探索範囲を絞ることで高速化できるとは思うんだな。

## 3次元復元候補とその確定
・誤対応を除去する意味で、特徴点の存在範囲をカメラの位置と透視射影変換から導出しその範囲にない3次元復元点は削除するアルゴリズム（カメラの位置が既知だからできる所業）（すでに三次元復元された特徴点をトラッキングしていればできる話）<br>
・新たに追加された特徴点に関しては三次元復元をとりあえず行い、三次元復元点候補にする<br>
・三次元復元候補点→確定までのフローを追加する感じ<br>
・これをしてれば対象が動いたときに候補点から当然復元点は削除されるので、とてもロバスト<br>
・さらにこの確定を行うところで3次元復元点の修正も行えるとベスト

## 三次元復元点の存在確率ノード設計
### 三次元復元ノード
入力：二枚の内視鏡画像、カメラ位置姿勢<br>
出力：三次元復元点（位置座標、色、特徴量を持つ）<br>

### 三次元点存在確率ノード
入力：三次元復元点（位置座標、色、特徴量）、キーフレーム画像、各キーフレーム時のカメラ位置姿勢<br>
・三次元復元点には位置とそこに存在する確率が入っている。<br>
・候補点は単純に２枚の画像から特徴点を抽出、マッチングし、カメラの位置を用いて三次元復元を行う。このときの確率を0.5とする。<br>
・次のカメラの位置と画像の入力があり、三次元復元点から画像への透視射影変換を行う。このときその透視射影した点周りに同等の特徴量のものが存在しなければその候補点の存在確率を下げる。<br>

# プログラム構成
## Tracking スレッド
- 特徴点の抽出
- カメラの位置取得
- キーフレーム作成
## Mapping スレッド
- キーフレームの挿入と削除
- 三次元復元点作成
- 点の占有格子地図作成

# 4/25
・[track_no, frame_id, u, v, R, t]を含んだPublisherの制作
・特徴点のマッチングについて、一つ前のフレームでトラッキングしてた点がknnMatchingの候補にあれば、それを優先的に使う
・Reconstructionノードの作成

# 3次元点の再投影について
すでに三次元復元した点について、再投影を現在のフレームに投影してその付近に同等の特徴点があるか確かめる。なければ「三次元復元点がまちがえている」or「眼球が移動してしまっている」と言える。つまりその三次元復元点を削除する言い訳になる。これをすることで、三次元復元点候補をもっと増やしても大丈夫なので、よりロバストに動作することを期待できる。
## 仕様
三次元点についてクラスを作成する。一つの点に対して必要な情報とは下記の通り。
- 三次元復元点
- どのKFを使用したか
- 特徴点情報(descriptor? cv::Keypoint?)
  
また、下記のような関数も必要
- 3次元点を現在のフレームに再投影してそもそもフレームに映り込むかどうかを判定する。映り込むのであればどこに映るかをcv::Point2fとして出力する。
- ある画像上の座標と特徴点情報を渡し、そこに同等の特徴点が存在するか判定する。
- 各特徴点にたいしてIDを降ってあげる。そしてそのIDをkeyとした辞書を作成。
- 十分確からしい三次元復元点を格納しpublish用に用意する

# 20200825
実装したいのは
- 指定の視点以上になっても前のデータを削除しないでそのまま計算するプログラム
- 必ず眼球内で三次元復元しているときは、分散は小さく距離も30mm以内の点群しかないので、そうなるようなフィルタをいれる
- matching_imageもpublish

備忘録
- 20200825_eye1.bag は/ts01_encoder をsub
- 20200825_eye2.bag は/joint_states をsub

# 20200827
実装したいこと
- 三次元復元をRANSACに対応させたい
- 三次元復元時に使えないフレームを判定し、それをkeypoint_mapから除外したい

## RANSAC
入力
- N視点のカメラの位置姿勢
- N視点での特徴点の位置

出力
- 三次元点

１　(x_i, y_i)の組から直線の式(ax+b=0)を求める
２　三次元点(x, y, z)を求める。

# 20200924
Estimation Pos [0.364855 -0.166364 -0.001397], r : 0.011561
 -> 位置は2.67mm、半径は0.5mmくらいの誤差

# 20201020
現在の課題は運動学がずれていること。それにいかにロバストに対処できるかが問題となってくる。その上で不可欠なのがいかに多くの特徴点IDと{カメラ位置、画像座標の位置}の組が得られるか。現在三次元復元とこの組を得るところは一つのノードして動作しているので、ループ周期が長くなりその組を多く得ることが難しくなっている。
そこで下記のようにシステムをわける。
- 内視鏡画像とカメラの位置姿勢を取得しKeyFrameDatabaseから使用するKeyFrameを取得しそれらからKeyFrameとのマッチングを行い、MapDatabaseに登録するノード
- MapDatabaseを元に三次元復元を行うノード
- KeyFrameDatabaseからMapDatabaseを更新するノード
## MapDatabaseについて
### 特徴点IDについて
MapDatabaseとは特徴点IDをKeyとした辞書型配列である。特徴点IDは基本的には「KFのフレーム番号+そのKFでの特徴点ID」で決定される。ただこのままではKF間の繋がりは完全に無視されてしまう。そこでKF間のマッチングを新しいKFが挿入されるタイミングで行う。この時特徴点がマッチングがされたものに関しては、登録が古い特徴ID側に新しいIDの情報を引き渡すようなことを行う。<br>
たとえば1~10のKFがすでに存在し、11番目のKFが新たに挿入された。このとき1,3番目のKFとマッチングがとれたとする。
```
[001001, 011032], [001102, 011023], [001054, 011293],
[003012, 011031], [003920, 011082], [003029, 011293]
```
この時マッチングされた11番目のKFの特徴点IDのものについては1, 3番目のID側へと情報が渡され、元のID情報については削除される。ここで[001054, 011293], [003029, 011293]のように1番と3番のマッチングではマッチングされなかったが、11番目のKFによって間接的にエッジが作成される場合がある。これについては要検討(誤対応によっておかしなエッジが作成されてしまう可能性があるため)。
### MapDatabaseの更新について
MapDatabaseはKeyFrameDatabaseに更新があった際に同時に更新される。KeyFrameDatabaseはKeyFrameに新たなマッチング情報が付与される時と、新たにKFが登録される際に更新される。新たなマッチング情報が付与された場合については、適切なIDを振り分けMapDatabaseに登録を行えばよい。
```cpp
mapdatabase.add(KeyFrame_Num, ID, MatchingData);
```
次に新たにKFが登録される際にはKF間の繋がりを見るために新規KFと過去分のKFの合計nC2通りのマッチングを行う。ここは非常に処理が重くなってしまうのでまずマッチングは過去分すべてについて行うのではなくある閾値以内のものについてのみ行う。
```cpp
mapdatabase.add(KeyFrame_Num, ID, MatchingData);
```

# 20201111
## ConvLSTMについて
現時点ではDenseNetのエンコーダと自前のデコーダを組み合わせることで深度推定を行っている。ただそれだと5mm程度の誤差が生じてしまっているのが現状。そこで、そもそもの推定値の精度を上げるためにもLSTMを導入したい。<br>
LSTMを実装するためには下記の事を作成する必要がある
- LSTM用のデータセットの作成
- LSTMは入力が5Dのテンソルであり、現在のものに加えてフレーム番号情報を乗っける必要がある。

# 20201115
## やること
- 修士論文執筆にあたり、どういうストーリーにするか考えて目次を制作する
- 眼球位置形状推定において挿入孔の精度が悪くあまり良い結果が得られてないので、挿入孔推定のアプローチを見直す

# 修士論文目次
## 序論
- 網膜硝子体手術の説明
- 内視鏡保持ロボット全般について
- 開発中の眼科用内視鏡保持ロボットについて
- 開発中の眼科用内視鏡保持ロボットの課題
- 研究目的：内視鏡保持ロボットで網膜の三次元復元を行うこと

## 内視鏡保持ロボットのハードウェア設計
- ロボットアームの簡易説明
- 各ユニットの説明
- 順運動学
- システム構成

## 三次元復元ソフトウェアの設計
- 一般的な三次元復元のはなし
- 三次元復元の手法の検討(SLAM、多視点+運動学での復元、深度推定)
- 深度推定の中でもDenseDepthについての説明
- モデルの学習方法について
- マップ生成のための占有グリッドについて

## 評価実験
- 位置既知の眼球モデルでの実験
- 豚眼での実験

## 結論